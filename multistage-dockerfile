# ==== BUILD STAGE ====

# Use a Node 16 base image for building the app
FROM node:16-alpine AS build

# Set the working directory to /app inside the container
WORKDIR /app

# Copy app files
COPY . .

# Install dependencies (npm ci makes sure the exact versions in the lockfile gets installed)
RUN npm ci

# Build the app
RUN npm run build


# ==== RUN STAGE ====

# Use a lightweight Node 16 base image for running the app
FROM node:16-alpine

# Set the working directory to /app inside the container
WORKDIR /app

# Copy the built app from the build stage to the current stage
COPY --from=build /app/package.json .
COPY --from=build /app/package-lock.json .
COPY --from=build /app/dist ./dist

# Install production dependencies
RUN npm ci --only=production

# Set the env to "production"
ENV NODE_ENV production

# Expose the port on which the app will be running (3000 is the default that `serve` uses)
EXPOSE 5173

# Start the app
CMD [ "node", "./dist/index.js" ]
